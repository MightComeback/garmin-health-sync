"use strict";var A=Object.create;var h=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var g=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var y=(r,t)=>{for(var e in t)h(r,e,{get:t[e],enumerable:!0})},p=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of _(t))!k.call(r,s)&&s!==e&&h(r,s,{get:()=>t[s],enumerable:!(i=E(t,s))||i.enumerable});return r};var u=(r,t,e)=>(e=r!=null?A(g(r)):{},p(t||!r||!r.__esModule?h(e,"default",{value:r,enumerable:!0}):e,r)),x=r=>p(h({},"__esModule",{value:!0}),r);var O={};y(O,{GarminService:()=>T,garminService:()=>D});module.exports=x(O);var d=require("child_process"),n=require("fs/promises"),f=require("fs"),w=require("uuid"),S=u(require("os"));const m="https://connect.garmin.com",l="https://sso.garmin.com",R=`${l}/cssls/oauth/authorization?response_type=code&client_id=3541974&scope=activity:read-all+activity:read-write+digital_wellness:read-all+social:read&redirect_uri=https%3A%2F%2Fconnect.garmin.com%2Fmodern&state=${(0,w.v4)()}`,v=`${l}/cssls/oauth/token`,P=`${l}/cssls/oauth/refresh`,C=`${m}/modern/proxy/activity-service/activity`,b=`${m}/modern/proxy/wellness-service/wellness-daily-summary`,o={AUTH_CODE:"@garmin_auth_code",ACCESS_TOKEN:"@garmin_access_token",REFRESH_TOKEN:"@garmin_refresh_token",EXPIRES_AT:"@garmin_expires_at"},$=()=>{const t=`${S.homedir()}/.garmin-health`;return(0,f.existsSync)(t)||import("fs").then(e=>e.mkdirSync(t,{recursive:!0})),t},a=r=>`${$()}/${r.replace("@","")}`;class T{accessToken=null;refreshToken=null;expiresAt=null;async init(){this.accessToken=await(0,n.readFile)(a(o.ACCESS_TOKEN),"utf8").catch(()=>null),this.refreshToken=await(0,n.readFile)(a(o.REFRESH_TOKEN),"utf8").catch(()=>null);const t=await(0,n.readFile)(a(o.EXPIRES_AT),"utf8").catch(()=>null);return t&&(this.expiresAt=parseInt(t,10)),!!(this.accessToken&&this.expiresAt&&this.expiresAt>Date.now())}getAuthorizationUrl(){return R}async exchangeCodeForTokens(t){try{const e=new URLSearchParams;e.append("client_id","3541974"),e.append("code",t),e.append("redirect_uri","https://connect.garmin.com/modern"),e.append("grant_type","authorization_code");const i=await fetch(v,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:e.toString()});if(!i.ok){const c=await i.text();throw new Error(`Failed to get tokens: ${c}`)}const s=await i.json();this.accessToken=s.access_token,this.refreshToken=s.refresh_token,this.expiresAt=Date.now()+s.expires_in*1e3,await Promise.all([(0,n.writeFile)(a(o.ACCESS_TOKEN),this.accessToken),(0,n.writeFile)(a(o.REFRESH_TOKEN),this.refreshToken),(0,n.writeFile)(a(o.EXPIRES_AT),this.expiresAt.toString())])}catch(e){throw console.error("Error exchanging code for tokens:",e),e}}async refreshAccessToken(){if(!this.refreshToken)return!1;try{const t=new URLSearchParams;t.append("client_id","3541974"),t.append("refresh_token",this.refreshToken),t.append("grant_type","refresh_token");const e=await fetch(P,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t.toString()});if(!e.ok){const s=await e.text();throw new Error(`Failed to refresh token: ${s}`)}const i=await e.json();return this.accessToken=i.access_token,this.refreshToken=i.refresh_token,this.expiresAt=Date.now()+i.expires_in*1e3,await Promise.all([(0,n.writeFile)(a(o.ACCESS_TOKEN),this.accessToken),(0,n.writeFile)(a(o.REFRESH_TOKEN),this.refreshToken),(0,n.writeFile)(a(o.EXPIRES_AT),this.expiresAt.toString())]),!0}catch(t){return console.error("Error refreshing token:",t),await this.clearTokens(),!1}}async clearTokens(){this.accessToken=null,this.refreshToken=null,this.expiresAt=null,await Promise.all([Promise.resolve((0,n.writeFile)(a(o.ACCESS_TOKEN),"")).catch(()=>{}),Promise.resolve((0,n.writeFile)(a(o.REFRESH_TOKEN),"")).catch(()=>{}),Promise.resolve((0,n.writeFile)(a(o.EXPIRES_AT),"")).catch(()=>{})])}async getActivities(t=30){if((!this.accessToken||this.expiresAt&&this.expiresAt<=Date.now())&&!await this.refreshAccessToken())throw new Error("Not authenticated. Please authorize with Garmin Connect.");try{const e=await fetch(`${C}?start=0&limit=${t*5}`,{headers:{Authorization:`Bearer ${this.accessToken}`,Accept:"application/json"}});if(!e.ok){if(e.status===401){if(!await this.refreshAccessToken())throw new Error("Authentication expired. Please re-authorize with Garmin Connect.");return await this.getActivities(t)}throw new Error(`Failed to get activities: ${e.statusText}`)}return(await e.json()).activities||[]}catch(e){throw console.error("Error fetching activities:",e),e}}async getWellnessData(t){if((!this.accessToken||this.expiresAt&&this.expiresAt<=Date.now())&&!await this.refreshAccessToken())throw new Error("Not authenticated. Please authorize with Garmin Connect.");try{const e=await fetch(`${b}/${t}`,{headers:{Authorization:`Bearer ${this.accessToken}`,Accept:"application/json"}});if(!e.ok){if(e.status===401){if(!await this.refreshAccessToken())throw new Error("Authentication expired. Please re-authorize with Garmin Connect.");return await this.getWellnessData(t)}if(e.status===404)return{restingHeartRate:null,bodyBattery:null,sleep:{duration:0,stages:[]}};throw new Error(`Failed to get wellness data: ${e.statusText}`)}return await e.json()}catch(e){throw console.error("Error fetching wellness data:",e),e}}isAuthenticated(){return!!(this.accessToken&&this.expiresAt&&this.expiresAt>Date.now())}async authorize(){return new Promise((t,e)=>{const i=this.getAuthorizationUrl(),s=(0,d.spawn)("open",[i],{stdio:"ignore"});s.on("error",e),s.on("close",c=>{c===0?t("Opened browser for authorization"):e(new Error(`Browser process exited with code ${c}`))}),setTimeout(()=>{t("Opened browser for authorization (timeout)")},300*1e3)})}}const D=new T;0&&(module.exports={GarminService,garminService});
